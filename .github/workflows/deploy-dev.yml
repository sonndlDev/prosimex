name: Deploy DEV

on:
  push:
    branches:
      - dev

  workflow_dispatch:
    inputs:
      version:
        description: "Docker image version to deploy (leave empty for latest dev)"
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS (DEV)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e
            echo "===== DEPLOY DEV START ====="

            APP_DIR="/var/www/prosimex-dev"
            IMAGE="ghcr.io/sonndlDev/frontend-dev"

            # Resolve version
            if [ -z "${{ github.event.inputs.version }}" ]; then
              VERSION="latest"
              echo "Deploying latest dev version"
            else
              VERSION="${{ github.event.inputs.version }}"
              echo "Deploying selected version: $VERSION"
            fi

            echo "Using image: $IMAGE:$VERSION"

            # Login GHCR (if needed)
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u sonndlDev --password-stdin

            echo "Pull image"
            docker pull $IMAGE:$VERSION

            echo "Stopping old container"
            docker stop frontend-dev || true
            docker rm frontend-dev || true

            echo "Starting new container"
            docker run -d \
              --name frontend-dev \
              -p 3000:80 \
              $IMAGE:$VERSION

            echo "===== DEPLOY DEV DONE ====="
